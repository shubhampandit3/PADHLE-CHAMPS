<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Management - Padhle Champs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .feedback-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .question-item { transition: all 0.3s ease; }
        .question-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .rating-display { background: linear-gradient(135deg, #10b981, #059669); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Padhle Champs</h1>
                <button onclick="window.location.href='home.html'" class="text-gray-600 hover:text-blue-600 transition-colors">
                    <i class="fas fa-home mr-2"></i>Back to Home
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="feedback-card p-8 text-white mb-8 rounded-2xl">
            <div class="text-center">
                <i class="fas fa-comments text-5xl mb-4 opacity-80"></i>
                <h2 class="text-3xl font-bold mb-2">Feedback Management</h2>
                <p class="opacity-80">Manage feedback questions and view student responses</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Questions Management -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-question-circle mr-2 text-blue-600"></i>Manage Questions
                </h3>
                
                <!-- Add Question -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <input type="text" id="newQuestion" placeholder="Enter new question..." class="w-full px-4 py-2 border rounded-lg mb-3 focus:ring-2 focus:ring-blue-500 outline-none">
                    <div class="flex gap-2">
                        <select id="ratingScale" class="px-3 py-2 border rounded-lg">
                            <option value="5">1-5 Scale</option>
                            <option value="10">1-10 Scale</option>
                        </select>
                        <button onclick="addQuestion()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                </div>

                <!-- Questions List -->
                <div id="questionsList" class="space-y-3">
                    <!-- Default questions will be loaded here -->
                </div>
            </div>

            <!-- Feedback Responses -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-bar mr-2 text-green-600"></i>Student Responses
                </h3>
                <div id="feedbackResponses" class="space-y-4">
                    <!-- Responses will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Send Feedback Form Button -->
        <div class="text-center mt-8">
            <button onclick="sendFeedbackForm()" class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                <i class="fas fa-paper-plane mr-2"></i>Send Feedback Form to Students
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCDZJeZeJPkuDUZ5Vf_-rsy0PQsx8tQw4k",
            authDomain: "quiz-app-10f81.firebaseapp.com",
            databaseURL: "https://quiz-app-10f81-default-rtdb.firebaseio.com",
            projectId: "quiz-app-10f81",
            storageBucket: "quiz-app-10f81.firebasestorage.app",
            messagingSenderId: "351578019731",
            appId: "1:351578019731:web:2055fe24498ca17908fa66",
            measurementId: "G-XVQ1GQ58E2"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const defaultQuestions = [
            { text: "How satisfied are you with the overall learning experience?", scale: 5 },
            { text: "How would you rate the quality of teaching materials?", scale: 5 },
            { text: "How easy is it to navigate the platform?", scale: 5 },
            { text: "How helpful are the practice tests and DPPs?", scale: 10 },
            { text: "How satisfied are you with teacher support?", scale: 5 }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('padhleChamps_user');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userData);
            if (user.role !== 'Teacher' && user.role !== 'teacher') {
                alert('Access denied. Only teachers can manage feedback.');
                window.location.href = 'home.html';
                return;
            }

            loadQuestions();
            loadFeedbackResponses();
        });

        async function loadQuestions() {
            try {
                const snapshot = await database.ref('feedbackQuestions').once('value');
                let questions = snapshot.val();
                
                if (!questions) {
                    // Set default questions
                    questions = {};
                    for (let i = 0; i < defaultQuestions.length; i++) {
                        const id = Date.now() + i;
                        questions[id] = defaultQuestions[i];
                    }
                    await database.ref('feedbackQuestions').set(questions);
                }
                
                displayQuestions(questions);
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsList');
            container.innerHTML = Object.keys(questions).map(id => `
                <div class="question-item bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${questions[id].text}</p>
                            <span class="text-sm text-gray-600">Scale: 1-${questions[id].scale}</span>
                        </div>
                        <button onclick="deleteQuestion('${id}')" class="text-red-600 hover:text-red-800 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function addQuestion() {
            const questionText = document.getElementById('newQuestion').value.trim();
            const scale = parseInt(document.getElementById('ratingScale').value);
            
            if (!questionText) {
                alert('Please enter a question.');
                return;
            }

            try {
                const id = Date.now();
                await database.ref(`feedbackQuestions/${id}`).set({
                    text: questionText,
                    scale: scale
                });
                
                document.getElementById('newQuestion').value = '';
                loadQuestions();
            } catch (error) {
                console.error('Error adding question:', error);
                alert('Failed to add question.');
            }
        }

        async function deleteQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    await database.ref(`feedbackQuestions/${id}`).remove();
                    loadQuestions();
                } catch (error) {
                    console.error('Error deleting question:', error);
                }
            }
        }

        async function loadFeedbackResponses() {
            try {
                const snapshot = await database.ref('feedbackResponses').orderByChild('timestamp').limitToLast(20).once('value');
                const responses = [];
                
                snapshot.forEach(childSnapshot => {
                    responses.unshift({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                displayFeedbackResponses(responses);
            } catch (error) {
                console.error('Error loading responses:', error);
            }
        }

        function displayFeedbackResponses(responses) {
            const container = document.getElementById('feedbackResponses');
            
            if (responses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No feedback responses yet.</p>';
                return;
            }

            container.innerHTML = responses.map(response => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-gray-800">${response.studentName}</h4>
                        <span class="text-sm text-gray-500">${new Date(response.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="space-y-2">
                        ${Object.keys(response.answers).map(questionId => {
                            const answer = response.answers[questionId];
                            const percentage = (answer.rating / answer.maxScale) * 100;
                            return `
                                <div class="text-sm">
                                    <p class="text-gray-700 mb-1">${answer.question}</p>
                                    <div class="flex items-center gap-2">
                                        <div class="rating-display text-white px-2 py-1 rounded text-xs font-semibold">
                                            ${answer.rating}/${answer.maxScale}
                                        </div>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function sendFeedbackForm() {
            try {
                const questionsSnapshot = await database.ref('feedbackQuestions').once('value');
                const questions = questionsSnapshot.val();
                
                if (!questions || Object.keys(questions).length === 0) {
                    alert('Please add at least one question before sending the feedback form.');
                    return;
                }

                const userData = JSON.parse(localStorage.getItem('padhleChamps_user'));
                
                await database.ref('feedbackFormRequest').set({
                    active: true,
                    timestamp: Date.now(),
                    sentBy: userData.name,
                    questions: questions
                });

                alert('Feedback form sent to all students! They will see it as a popup on the home page.');
            } catch (error) {
                console.error('Error sending feedback form:', error);
                alert('Failed to send feedback form.');
            }
        }
    </script>
</body>
</html>